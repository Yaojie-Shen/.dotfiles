#!/usr/bin/env bash

set -e

source "${BASH_SOURCE%/*}/../libexec/devbox-utils"

# Ensure Homebrew is available on macOS
ensure_homebrew() {
  if ! command -v brew >/dev/null 2>&1; then
    error "Homebrew not found. Please install Homebrew first: https://brew.sh/"
    exit 1
  fi
}

# --------------------------------
# Install Linux dependencies
# --------------------------------
install_build_deps() {
  local OS
  OS="$(uname -s)"
  if [[ "$OS" == "Darwin" ]]; then
    info "Detected macOS â€” installing pyenv build dependencies via Homebrew"

    ensure_homebrew

    # Packages requested by user
    local pkgs=(openssl readline sqlite3 xz tcl-tk@8 libb2 zstd zlib pkgconfig)

    info "Updating Homebrew and installing: ${pkgs[*]}"
    brew update
    brew install "${pkgs[@]}"

    return
  fi

  info "Installing pyenv dependencies on Linux..."

  if command -v apt-get >/dev/null 2>&1; then
    info "Using apt-get"
    sudo apt-get update
    sudo apt-get install -y \
      make build-essential libssl-dev zlib1g-dev \
      libbz2-dev libreadline-dev libsqlite3-dev curl git \
      libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev

  elif command -v dnf >/dev/null 2>&1; then
    info "Using dnf"
    sudo dnf install -y \
      make gcc patch zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl-devel tk-devel libffi-devel xz-devel libuuid-devel gdbm-libs libnsl2

  elif command -v yum >/dev/null 2>&1; then
    info "Using yum"
    sudo yum install -y \
      gcc make patch zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl11-devel tk-devel libffi-devel xz-devel

  elif command -v pacman >/dev/null 2>&1; then
    info "Using pacman"
    sudo pacman -Sy --noconfirm \
      --needed base-devel openssl zlib xz tk zstd

  else
    warning "No supported package manager found. Please ensure build environment for python are installed before install new Python version."

  fi
}

# --------------------------------
# Install Pyenv
# --------------------------------
install_pyenv() {
  OS="$(uname -s)"
  if [[ "$OS" == "Darwin" ]]; then
    info "Detected macOS"

    ensure_homebrew

    if brew list pyenv >/dev/null 2>&1; then
      warning "pyenv already installed via Homebrew, skipping."
    else
      info "Installing pyenv via Homebrew..."
      brew update
      brew install pyenv
    fi

    # Install pyenv-virtualenv via Homebrew on macOS
    if brew list pyenv-virtualenv >/dev/null 2>&1; then
      warning "pyenv-virtualenv already installed via Homebrew, skipping."
    else
      info "Installing pyenv-virtualenv via Homebrew..."
      brew install pyenv-virtualenv
    fi

  else
    info "Detected Linux/Unix"
    install_build_deps

    if [[ -d "$HOME/.pyenv" ]]; then
      warning "$HOME/.pyenv already exists, skipping installation."
    else
      info "Installing pyenv via git..."
      git clone https://github.com/pyenv/pyenv.git "$HOME/.pyenv"
    fi

    # Install pyenv-virtualenv via git into $HOME/.pyenv/plugins on Linux
    local plugin_dir="$HOME/.pyenv/plugins/pyenv-virtualenv"
    if [[ -d "$plugin_dir" ]]; then
      warning "pyenv-virtualenv already installed at $plugin_dir, skipping."
    else
      info "Installing pyenv-virtualenv into $plugin_dir"
      mkdir -p "$(dirname "$plugin_dir")"
      git clone https://github.com/pyenv/pyenv-virtualenv.git "$plugin_dir"
    fi
  fi
}

# --------------------------------
# Configure shell rc file
# --------------------------------
configure_pyenv_rc() {
  local rc_file="$1"
  local shell_name="$2"
  local content
  content=$(cat <<EOF
export PYENV_ROOT="\$HOME/.pyenv"\n[[ -d "\$PYENV_ROOT/bin" ]] && export PATH="\$PYENV_ROOT/bin:\$PATH"\neval "\$(pyenv init - $shell_name)"\neval "\$(pyenv virtualenv-init -)"
EOF
  )

  configure_rc_block \
    "$rc_file" \
    "# >>> pyenv initialize >>>" \
    "# <<< pyenv initialize <<<" \
    "$content"
}

# --------------------------------
# Main
# --------------------------------
info "Installing pyenv..."
install_pyenv

info "Configuring ~/.zshrc"
configure_pyenv_rc "$HOME/.zshrc" "zsh"

info "Configuring ~/.bashrc"
configure_pyenv_rc "$HOME/.bashrc" "bash"

success "Pyenv installation and configuration complete."

exec $SHELL

