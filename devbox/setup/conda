#!/usr/bin/env bash

set -Eeuo pipefail

source "${BASH_SOURCE%/*}/../libexec/devbox-utils"

# -----------------------------
# Defaults
# -----------------------------
MINICONDA_DIR="${HOME}/miniconda3"
VERSION="latest"
FORCE=0
UNINSTALL=0
SHELLS=(bash zsh)

# -----------------------------
# Usage
# -----------------------------
usage() {
  cat <<EOF
Usage: $0 [options]

Options:
  -v, --version <version>   Install specific Miniconda version (default: latest)
  -f, --force               Force reinstall (remove existing installation)
  -u, --uninstall           Uninstall Miniconda
  -h, --help                Show this help message
EOF
}

# -----------------------------
# Parse command line options
# -----------------------------
while [[ $# -gt 0 ]]; do
  case "$1" in
    -v|--version)
      VERSION="$2"
      shift 2
      ;;
    -f|--force)
      FORCE=1
      shift
      ;;
    -u|--uninstall)
      UNINSTALL=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      error "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

# -----------------------------
# Platform detection
# -----------------------------
detect_platform() {
  local os arch

  os="$(uname -s)"
  arch="$(uname -m)"

  case "$os" in
    Linux)  os="Linux" ;;
    Darwin) os="MacOSX" ;;
    *)
      error "Unsupported OS: $os"
      exit 1
      ;;
  esac

  case "$arch" in
    x86_64|amd64) arch="x86_64" ;;
    arm64|aarch64) arch="arm64" ;;
    *)
      error "Unsupported architecture: $arch"
      exit 1
      ;;
  esac

  echo "${os}-${arch}"
}

PLATFORM="$(detect_platform)"

# -----------------------------
# Resolve installer filename
# -----------------------------
installer_name() {
  if [[ "$VERSION" == "latest" ]]; then
    echo "Miniconda3-latest-${PLATFORM}.sh"
  else
    echo "Miniconda3-${VERSION}-${PLATFORM}.sh"
  fi
}

INSTALLER="$(installer_name)"
INSTALLER_URL="https://repo.anaconda.com/miniconda/${INSTALLER}"

# -----------------------------
# Install Miniconda
# -----------------------------
install_miniconda() {
  mkdir -p "${MINICONDA_DIR}"
  info "Downloading ${INSTALLER}..."
  wget "${INSTALLER_URL}" -O "${MINICONDA_DIR}/miniconda.sh"
  bash "${MINICONDA_DIR}/miniconda.sh" -b -u -p "${MINICONDA_DIR}"
  rm -f "${MINICONDA_DIR}/miniconda.sh"
}

# -----------------------------
# Initialize Miniconda
# (Older conda may not support 'conda init')
# -----------------------------
initialize_miniconda() {
  if "${MINICONDA_DIR}/bin/conda" init --help >/dev/null 2>&1; then
    "${MINICONDA_DIR}/bin/conda" init "$@" || warning "conda init failed (ignored)"
  else
    warning "conda init not supported in this conda version, skipping."
  fi
}

# -----------------------------
# Uninstall Miniconda
# -----------------------------
uninstall_miniconda() {
  info "Uninstalling Miniconda..."
  if [[ -d "${MINICONDA_DIR}" ]]; then
    rm -rf "${MINICONDA_DIR}"
    success "Miniconda removed."
  else
    warning "Miniconda not found at ${MINICONDA_DIR}."
  fi
}

# -----------------------------
# Handle uninstall
# -----------------------------
if [[ "$UNINSTALL" -eq 1 ]]; then
  uninstall_miniconda
  exit 0
fi

# -----------------------------
# Force reinstall
# -----------------------------
if [[ "$FORCE" -eq 1 && -d "${MINICONDA_DIR}" ]]; then
  info "Force reinstall enabled. Removing existing Miniconda..."
  uninstall_miniconda
fi

# -----------------------------
# Main installation logic
# -----------------------------
info "Installing Miniconda..."
if [[ -d "${MINICONDA_DIR}" ]]; then
  warning "${MINICONDA_DIR} already exists, skipping installation."
else
  install_miniconda
  success "Miniconda installation complete."
fi

# -----------------------------
# Shell initialization
# -----------------------------
info "Initializing Miniconda for your shell (${SHELLS[*]})..."
initialize_miniconda "${SHELLS[@]}"

success "Conda setup complete."
